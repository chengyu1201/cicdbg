# Cloud Build åªè¨˜éŒ„åˆ° Cloud Loggingï¼ˆç°¡æ½”ï¼‰
options:
  logging: CLOUD_LOGGING_ONLY

# ğŸ”§ å¯èª¿åƒæ•¸ï¼ˆsubstitution è®Šæ•¸ï¼‰ï¼š
# æ³¨æ„ï¼šé€™äº›æ˜¯ã€Œå»ºç½®æœŸæ›¿æ›ã€çš„è®Šæ•¸ï¼Œåå­—ä¸€å¾‹ä»¥ä¸‹åŠƒç·šé–‹é ­ã€‚
substitutions:
  _REGION: asia-east1                 # ä½ çš„å€åŸŸ
  _AR_REPO: cicd-bluegreen-docker     # ä½ çš„ Artifact Registry repository
  _SERVICE: cicdbg                    # ä½ çš„ Cloud Run æœå‹™å
  _NEXT_TAG: ""                       # å¯é¸ï¼šæ‰‹å‹•æŒ‡å®š blue/greenï¼›ç•™ç©º=è‡ªå‹•åˆ¤æ–·
  _RUNTIME_SA_EMAIL: ""               # å¯é¸ï¼šè‹¥ä½ è¦ç”¨è‡ªè¨‚åŸ·è¡Œ SA çš„ã€Œemailã€ï¼Œåœ¨ Trigger è£œé€™å€‹ï¼›ç•™ç©º=ç”¨ Compute Default SA

# ğŸ“Œ æ­¥é©Ÿ 0ï¼šBuild æˆå®¹å™¨æ˜ åƒ
steps:
  - name: gcr.io/cloud-builders/docker
    id: build
    args:
      - build
      - -t
      # é€™è£¡ç”¨çš„æ˜¯ã€Œå»ºç½®æœŸã€è®Šæ•¸ï¼š${_REGION}ã€${PROJECT_ID}ã€${_AR_REPO}ã€${_SERVICE}ã€${SHORT_SHA}
      # ç”± Cloud Build åœ¨åŸ·è¡Œå‰å°±æŠŠé€™äº›å­—ä¸²æ›¿æ›æˆçœŸçš„å€¼
      - ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE}:${SHORT_SHA}
      - .

  # ğŸ“Œ æ­¥é©Ÿ 1ï¼šPush åˆ° Artifact Registry
  - name: gcr.io/cloud-builders/docker
    id: push
    args:
      - push
      - ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE}:${SHORT_SHA}

  # ğŸ“Œ æ­¥é©Ÿ 2ï¼šæ±ºå®šä¸‹ä¸€å€‹é¡è‰²ï¼ˆblue/greenï¼‰
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
    id: decide-color
    entrypoint: bash
    args:
      - -ceu
      - |
        # -eï¼šä»»ä¸€æŒ‡ä»¤éŒ¯èª¤å°±é€€å‡º
        # -uï¼šç”¨åˆ°æœªå®šç¾©è®Šæ•¸å°±å ±éŒ¯ï¼ˆæ‰€ä»¥è®€ substitution è¦å¯«æˆ ${_VAR:-}ï¼‰
        # pipefailï¼šç®¡ç·šä»»ä¸€æ®µéŒ¯èª¤éƒ½è¦–ç‚ºéŒ¯
        set -euo pipefail

        # è®€ä½¿ç”¨è€…æ˜¯å¦åœ¨ Trigger æŒ‡å®šäº† _NEXT_TAGï¼ˆå¯èƒ½æ²’å¡«ï¼Œæ‰€ä»¥ç”¨ ${_NEXT_TAG:-}ï¼‰
        USER_NEXT="${_NEXT_TAG:-}"

        if [[ -n "$$USER_NEXT" ]]; then
          # ç™½åå–®æª¢æŸ¥ï¼Œé¿å…äº‚å¡«
          if [[ "$$USER_NEXT" != "blue" && "$$USER_NEXT" != "green" ]]; then
            echo "invalid _NEXT_TAG=$USER_NEXT"; exit 1
          fi
          NEXT_TAG="$$USER_NEXT"    # â† é€™æ˜¯ bash è®Šæ•¸ï¼ˆåŸ·è¡ŒæœŸï¼‰
        else
          # æŸ¥ç›®å‰æœå‹™çš„ä¸»è¦æµé‡ tagï¼ˆå¯èƒ½å–ä¸åˆ°ï¼Œæ‰€ä»¥ || trueï¼‰
          CURR="$(gcloud run services describe "${_SERVICE}" --region "${_REGION}" \
            --format='value(status.traffic[0].tag)' || true)"
          # è‹¥å–ä¸åˆ°ï¼Œé è¨­è¦–ç‚º blueï¼Œåœ¨è—ç¶ ä¸Šç¬¬ä¸€æ¬¡å°±æœƒä½ˆç½² green(0%)
          if [[ "${CURR:-blue}" == "blue" ]]; then NEXT_TAG=green; else NEXT_TAG=blue; fi
        fi

        # æŠŠ bash è®Šæ•¸å¯«åˆ°æª”æ¡ˆï¼Œè®“ä¸‹ä¸€æ­¥ source ä½¿ç”¨ã€‚
        # é€™è£¡å¯«æˆ $$NEXT_TAG æ˜¯ç‚ºäº†é¿å… Cloud Build æŠŠ $NEXT_TAG èª¤ç•¶æˆ substitutionã€‚
        echo "NEXT_TAG=$$NEXT_TAG" | tee /workspace/next_color

  # ğŸ“Œ æ­¥é©Ÿ 3ï¼šéƒ¨ç½²æ–°ä¿®è¨‚ï¼ˆ0% æµé‡ï¼‰
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
    id: deploy-no-traffic
    entrypoint: bash
    args:
      - -ceu
      - |
        set -euo pipefail

        # è®€ä¸Šä¸€æ­¥å¯«çš„çµæœï¼Œå–å¾— bash è®Šæ•¸ NEXT_TAG
        source /workspace/next_color

        # å»ºå‡ºè¦éƒ¨ç½²çš„æ˜ åƒåç¨±ï¼ˆé€™äº›æ˜¯å»ºç½®æœŸ substitutionï¼ŒCloud Build æœƒå…ˆæ›¿æ›ï¼‰
        IMAGE="${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE}:${SHORT_SHA}"

        # ğŸ”‘ æ±ºå®šåŸ·è¡Œæ™‚çš„ Service Account email
        # 1) è‹¥ä½¿ç”¨è€…åœ¨ Trigger æä¾›äº† _RUNTIME_SA_EMAILï¼ˆsubstitutionï¼‰ï¼Œå°±ç”¨å®ƒ
        # 2) å¦å‰‡é è¨­ç”¨ Compute Default SAï¼š<PROJECT_NUMBER>-compute@developer.gserviceaccount.com
        #    é€™è£¡ç”¨çš„æ˜¯ã€Œå…§å»º substitutionã€${PROJECT_NUMBER}ï¼ŒCloud Build æœƒå…ˆæ›¿æ›æˆæ•¸å­—ï¼Œ
        #    é€™æ¨£ bash å°±ä¸æœƒçœ‹åˆ°æœªå®šç¾©çš„ $PROJECT_NUMBERï¼ˆé¿å…ä½ å‰›å‰›çš„ unbound variableï¼‰
        SA_EMAIL="${_RUNTIME_SA_EMAIL:-${PROJECT_NUMBER}-compute@developer.gserviceaccount.com}"

        echo "Deploying image: $IMAGE with tag: $NEXT_TAG (no traffic) using SA: $SA_EMAIL"

        # éƒ¨ç½²åˆ° Cloud Runï¼šåŠ ä¸Š tagï¼Œä¸¦æŒ‡å®š --no-traffic è®“å®ƒå…ˆ 0%
        gcloud run deploy "${_SERVICE}" \
          --image "$IMAGE" \
          --region "${_REGION}" \
          --tag "$NEXT_TAG" \
          --no-traffic \
          --service-account "$SA_EMAIL" \
          --set-env-vars=APP_VERSION="${SHORT_SHA}",APP_COLOR="$NEXT_TAG"

  # ğŸ“Œ æ­¥é©Ÿ 4ï¼šæç¤ºä¸‹ä¸€æ­¥ï¼ˆåˆ° Console ç”¨ tag URL é©—è­‰ /healthzï¼Œç„¶å¾Œåˆ‡æµé‡ï¼‰
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
    id: hint
    entrypoint: bash
    args:
      - -ceu
      - |
        set -euo pipefail
        source /workspace/next_color
        echo "Deployed ${_SERVICE} new revision with tag=$NEXT_TAG at 0%."
        echo "åˆ° Cloud Run > ${_SERVICE} > Revisions > Tags è¤‡è£½ $NEXT_TAG çš„ tag URL æ¸¬è©¦ /healthzã€‚"
        echo "æ¸¬é€šéå¾Œåˆ° Manage traffic åˆ‡ $NEXT_TAG=100%ï¼ˆæˆ–é‡‘çµ²é›€ 1%ã€5%ã€10% â€¦ï¼‰"

# è‹¥ä½ è¦å»ºç½®é€šéå°±è‡ªå‹•åˆ‡ 100%ï¼Œå¯ä»¥æ‰“é–‹ä¸‹é¢é€™æ®µï¼ˆåŒæ¨£ç”¨ bash è®Šæ•¸ï¼Œæ‰€ä»¥æ˜¯ $NEXT_TAGï¼‰
#  - name: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
#    id: promote-to-100
#    entrypoint: bash
#    args:
#      - -ceu
#      - |
#        set -euo pipefail
#        source /workspace/next_color
#        gcloud run services update-traffic "${_SERVICE}" \
#          --region "${_REGION}" \
#          --to-tags "$NEXT_TAG=100"
#        echo "Traffic switched to $NEXT_TAG=100%"

# é€™è¡Œè®“ Build é é¢èƒ½çœ‹åˆ°å‰›å‰› Push çš„æ˜ åƒ
images:
  - ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO}/${_SERVICE}:${SHORT_SHA}
